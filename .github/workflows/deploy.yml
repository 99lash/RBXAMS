name: Build and Deploy to Hostinger

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout code
      - name: Checkout code
        uses: actions/checkout@v4

      # 2️⃣ Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 3️⃣ Install deps and build Tailwind/DaisyUI
      - name: Build CSS assets
        run: |
          npm ci
          npm run build:css

      # 4️⃣ Setup SSH key for connectivity + deployment
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.HOSTINGER_SSH_KEY }}" > ~/.ssh/workflow_key
          chmod 600 ~/.ssh/workflow_key
          ssh-keyscan -p ${{ secrets.HOSTINGER_PORT }} ${{ secrets.HOSTINGER_HOST }} >> ~/.ssh/known_hosts

      # 5️⃣ Test SSH connectivity
      - name: Test SSH connection
        run: |
          echo "Testing SSH connection..."
          ssh -p ${{ secrets.HOSTINGER_PORT }} -i ~/.ssh/workflow_key -o StrictHostKeyChecking=no ${{ secrets.HOSTINGER_USER }}@${{ secrets.HOSTINGER_HOST }} "echo ✅ SSH OK"

      # 6️⃣ Deploy via SSH
      - name: Deploy to Hostinger
        uses: easingthemes/ssh-deploy@v4
        env:
          SSH_PRIVATE_KEY: ${{ secrets.HOSTINGER_SSH_KEY }}
          REMOTE_HOST: ${{ secrets.HOSTINGER_HOST }}
          REMOTE_USER: ${{ secrets.HOSTINGER_USER }}
          REMOTE_PORT: ${{ secrets.HOSTINGER_PORT }}
          REMOTE_PATH: ${{ secrets.REMOTE_PATH }}
          SOURCE: ".,!node_modules/,!.git/,!.github/,!README.md"
